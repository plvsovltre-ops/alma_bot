import streamlit as st
import os
import glob
from google import genai
from google.genai import types

# --- 1. –ù–ê–°–¢–†–û–ô–ö–ò –°–¢–†–ê–ù–ò–¶–´ ---
st.set_page_config(page_title="–Æ—Ä–∏—Å—Ç –ê–õ–ú–ê", page_icon="‚öñÔ∏è", layout="centered")

# –°–∫—Ä—ã–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –º–µ–Ω—é Streamlit –∏ —Ñ—É—Ç–µ—Ä –¥–ª—è —á–∏—Å—Ç–æ—Ç—ã
st.markdown("""
    <style>
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
    header {visibility: hidden;}
    .stChatInput {bottom: 20px;}
    </style>
    """, unsafe_allow_html=True)

st.title("‚öñÔ∏è –Æ—Ä–∏—Å—Ç –ê–õ–ú–ê (Alma Zanger)")
st.caption("–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –∑–∞—â–∏—Ç–µ –ø—Ä–µ–¥–≥–æ—Ä–∏–π –∏ —ç–∫–æ–ª–æ–≥–∏–∏ –ê–ª–º–∞—Ç—ã")

# --- 2. –Æ–†–ò–î–ò–ß–ï–°–ö–ò–ô –î–ò–°–ö–õ–ï–ô–ú–ï–† (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û) ---
with st.expander("üìú –í–ê–ñ–ù–û: –£—Å–ª–æ–≤–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –ø—Ä–æ—á–∏—Ç–∞—Ç—å)", expanded=True):
    st.warning("""
    **–í–ù–ò–ú–ê–ù–ò–ï:** –î–∞–Ω–Ω—ã–π —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –±–∞–∑–µ –ò—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç–∞.
    1. –û—Ç–≤–µ—Ç—ã –Ω–æ—Å—è—Ç **–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π —Ö–∞—Ä–∞–∫—Ç–µ—Ä** –∏ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–π —é—Ä–∏–¥–∏—á–µ—Å–∫–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–µ–π.
    2. –î–≤–∏–∂–µ–Ω–∏–µ ALMA –Ω–µ –Ω–µ—Å–µ—Ç –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ –∑–∞ –¥–µ–π—Å—Ç–≤–∏—è, —Å–æ–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –æ—Ç–≤–µ—Ç–æ–≤ –±–æ—Ç–∞.
    3. –î–ª—è —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∏—Å–∫–æ–≤ –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≤ —Å—É–¥–µ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–º—É –∞–¥–≤–æ–∫–∞—Ç—É.
    """)
    agreement = st.checkbox("–Ø –ø–æ–Ω–∏–º–∞—é —Ä–∏—Å–∫–∏ –∏ —Å–æ–≥–ª–∞—Å–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å –∫–∞–∫ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫.")

if not agreement:
    st.info("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–∏–º–∏—Ç–µ —É—Å–ª–æ–≤–∏—è –≤—ã—à–µ, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é.")
    st.stop()

# --- 3. –ó–ê–ì–†–£–ó–ö–ê –ë–ê–ó–´ –ó–ù–ê–ù–ò–ô ---
@st.cache_resource
def load_knowledge():
    knowledge = ""
    folder_path = "laws"
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–∞–ø–∫–∏
    if not os.path.exists(folder_path):
        return f"–û–®–ò–ë–ö–ê: –ü–∞–ø–∫–∞ '{folder_path}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –°–æ–∑–¥–∞–π—Ç–µ –µ—ë –∏ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ç—É–¥–∞ txt —Ñ–∞–π–ª—ã."
    
    # –ü–æ–∏—Å–∫ —Ñ–∞–π–ª–æ–≤ .txt
    files = sorted(glob.glob(os.path.join(folder_path, "*.txt")))
    
    if not files:
        return f"–û–®–ò–ë–ö–ê: –í –ø–∞–ø–∫–µ '{folder_path}' –Ω–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤."

    # –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤
    for file_path in files:
        try:
            with open(file_path, "r", encoding="utf-8") as f:
                filename = os.path.basename(file_path)
                knowledge += f"\n\n--- –î–û–ö–£–ú–ï–ù–¢: {filename} ---\n"
                knowledge += f.read()
        except Exception as e:
            knowledge += f"\n[–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ {file_path}: {e}]\n"
            
    return knowledge

knowledge_base = load_knowledge()

# –ï—Å–ª–∏ –±–∞–∑–∞ –ø—É—Å—Ç–∞—è –∏–ª–∏ —Å –æ—à–∏–±–∫–æ–π ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º
if knowledge_base.startswith("–û–®–ò–ë–ö–ê"):
    st.error(knowledge_base)
    st.stop()

# --- 4. –ù–ê–°–¢–†–û–ô–ö–ê GEMINI CLIENT ---
api_key = st.secrets.get("GEMINI_API_KEY")

if not api_key:
    st.error("–°–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞: –ù–µ –Ω–∞–π–¥–µ–Ω API –∫–ª—é—á (GEMINI_API_KEY). –î–æ–±–∞–≤—å—Ç–µ –µ–≥–æ –≤ Secrets –Ω–∞ —Å–∞–π—Ç–µ Streamlit.")
    st.stop()

client = genai.Client(api_key=api_key)

# --- 5. –ò–ù–¢–ï–†–§–ï–ô–° –ß–ê–¢–ê ---
if "messages" not in st.session_state:
    st.session_state.messages = [
        {"role": "assistant", "content": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø ‚Äî —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–≤–∏–∂–µ–Ω–∏—è ALMA. –û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É (–Ω–∞–ø—Ä–∏–º–µ—Ä: *'–°—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Å–∫–ª–æ–Ω–µ'*, *'–†—É–±—è—Ç –¥–µ—Ä–µ–≤—å—è'*, *'–ó–∞–±–æ—Ä —É —Ä–µ–∫–∏'*), –∏ —è –ø–æ–¥–±–µ—Ä—É —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –∑–∞–∫–æ–Ω—ã."}
    ]

# –í—ã–≤–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏ –ø–µ—Ä–µ–ø–∏—Å–∫–∏
for msg in st.session_state.messages:
    with st.chat_message(msg["role"]):
        st.write(msg["content"])

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
if prompt := st.chat_input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –≤–æ–ø—Ä–æ—Å..."):
    # 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    st.session_state.messages.append({"role": "user", "content": prompt})
    with st.chat_message("user"):
        st.write(prompt)

    # 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    with st.chat_message("assistant"):
        placeholder = st.empty()
        full_response = ""
        
        # –°–∏—Å—Ç–µ–º–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è (–ú–æ–∑–≥ —é—Ä–∏—Å—Ç–∞)
        system_instruction = f"""
        –¢–´ ‚Äî –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –Æ—Ä–∏—Å—Ç –æ–±—â–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è ALMA (Alma Zanger).
        –¢–í–û–Ø –ó–ê–î–ê–ß–ê: –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä–∞–∂–¥–∞–Ω –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –∑–∞—â–∏—Ç—ã —ç–∫–æ–ª–æ–≥–∏–∏ –∏ –≥—Ä–∞–¥–æ—Å—Ç—Ä–æ–∏—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –ê–ª–º–∞—Ç—ã, –∏—Å–ø–æ–ª—å–∑—É—è –¢–û–õ–¨–ö–û –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—É—é –ë–∞–∑—É –ó–Ω–∞–Ω–∏–π.
        
        –¢–í–û–Ø –ë–ê–ó–ê –ó–ù–ê–ù–ò–ô:
        {knowledge_base}
        
        –ò–ù–°–¢–†–£–ö–¶–ò–Ø:
        1. –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –ö–û–ù–ö–†–ï–¢–ù–´–ï —Ñ–∞–π–ª—ã, —Å—Ç–∞—Ç—å–∏ –∏ –ø—É–Ω–∫—Ç—ã –∑–∞–∫–æ–Ω–æ–≤ –∏–∑ –±–∞–∑—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–°–æ–≥–ª–∞—Å–Ω–æ —Å—Ç. 324 –£–ö –†–ö –∏–∑ —Ñ–∞–π–ª–∞ 05_crime_code.txt...").
        2. –ï—Å–ª–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–µ —Å–µ—Ä—å–µ–∑–Ω–æ–µ (–°—Ü–µ–Ω–∞—Ä–∏–π –ê –∏–∑ —Ñ–∞–π–ª–∞ guidelines), –ø—Ä–µ–¥–ª–æ–∂–∏ —á–µ—Ç–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º –¥–µ–π—Å—Ç–≤–∏–π.
        3. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç –≤ –±–∞–∑–µ, —Ç–∞–∫ –∏ —Å–∫–∞–∂–∏: "–í –º–æ–µ–π –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –ø–æ —ç—Ç–æ–º—É –≤–æ–ø—Ä–æ—Å—É". –ù–ï –í–´–î–£–ú–´–í–ê–ô –∑–∞–∫–æ–Ω—ã.
        4. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ç–æ–º —è–∑—ã–∫–µ, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–º –∑–∞–¥–∞–Ω –≤–æ–ø—Ä–æ—Å (–†—É—Å—Å–∫–∏–π –∏–ª–∏ –ö–∞–∑–∞—Ö—Å–∫–∏–π).
        """

        try:
            # –ó–∞–ø—Ä–æ—Å –∫ –º–æ–¥–µ–ª–∏
            response = client.models.generate_content(
                model="gemini-1.5-flash",
                contents=[system_instruction, prompt],
                config=types.GenerateContentConfig(
                    temperature=0.0,  # –ù–û–õ–¨ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Ç–æ—á–Ω–æ—Å—Ç–∏ —Ñ–∞–∫—Ç–æ–≤
                    max_output_tokens=2000
                )
            )
            full_response = response.text
            placeholder.markdown(full_response)
        except Exception as e:
            full_response = f"–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å AI: {e}"
            placeholder.error(full_response)

    # 3. –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –≤ –∏—Å—Ç–æ—Ä–∏—é
    st.session_state.messages.append({"role": "assistant", "content": full_response})
